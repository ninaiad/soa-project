# Main service REST API

Основной сервис социальной сети, реализующий аутентификацию пользователей и работу с их личными данными. Для приложения написан отдельный образ, который автоматически запускается после запуска и инициализации образа СУБД PostgreSQL.

Описание методов в спецификации Open API находятся в файле [`openapi.yml`](https://github.com/ninaiad/soa-project/blob/main-rest-api/main-service/openapi.yml).

## Структура программы

Программа запускается из файла `cmd/main.go`. Каждый отдельный сервер, обрабатывающий HTTP запросы, запускается методом Run (см. файл `http-server.go`). Структуры информации, хранящие данные пользователей, которые являются общими для всех компонент приложения можно найти в `user.go`.

Серверная часть веб-приложения разделена на три основных части: 
1. Handler, обрабатывающая HTTP запросы клиента;
2. Service, на уровне которого реализуется логика обработки данных и работа с аутентификацией;
3. Database, работающая с СУБД.

### Handler

Уровень Handler работает с клиентом, обрабатывая HTTP запросы. Запросы обрабатываются асинхронно при помощи использования легковесных потоков goroutine (см. файл `cmd/main.go`). В случае некорректного формата входных данных, клиенту отправляется ответ о неуспехе выполненного запроса с текстом ошибки, иначе данные передаются на уровень ниже, в Service, после приведения их в нужный формат. В случае ошибки на любых последующих уровнях, сервер отправляет клиенту соответствующий код об ошибке и его описание.

#### /pkg/handler/handler.go
В этом файле инициализируется данная компонента, а также описаны все общие для этого уровня интерфейсы и структуры.

#### /pkg/handler/auth.go
Здесь находятся функции-обработчики handlers HTTP запросов, связанных с аутентификацией.

#### /pkg/handler/posts.go
Здесь находятся функции-обработчики handlers HTTP запросов, связанных с созданием и просмотром постов пользователей (запросы перенаправляются в gRPC сервер Posts Service).

#### /pkg/handler/userid.go
В данном файле происходит высокоуровневая работа с аутентификацией клиентов: верификация запросов, для которых требуется предварительная аутентификация, через компоненту Service, получение id пользователя по входным данным.

### Service
В компоненте Service происходит обработка данных перед отправкой их клиенту или записи в базу данных и реализуется аутентификация пользователей социальной сети.

#### /pkg/service/service.go
В этом файле инициализируется данная компонента, а также описаны все общие для этого уровня интерфейсы и структуры.

#### /pkg/service/auth.go
При создании новой учетной записи или авторизации в уже существующую, в случае успешного обновления базы данных, для клиента генерируется Bearer token по стандарту JWT (JSON Web Token), используя который в последующих запросах, клиент получает доступ к просмотру и обновлению своих данных. 
Также на этом уровне обрабатываются пароли пользователей, перед сохранением их в базу данных. Это делает работу системы более безопасной. Введенные пароли хешируется, после добавления к ним соли. 

### Database

На данном уровне программы, происходит работа с СУБД: подключение к ней (а именно к отдельному приложению PostgreSQL, обернутому в Docker контейнер), инициализация базы данных с помощью файлов миграций, а также модификация ее содержимого, согласно запросам клиента после их обработки на уровне Service.

Для работы с PostgreSQL используется две библиотеки для Go: `sqlx`, которая обладает более широким функционалом и удобным интерфейсом, чем нативная `database/sql` из стандартной библиотеки языка, и `migrate`, с помощью которой можно автоматически мигрировать базы данных в самой программе, что значительно упрощает общую сборку и запуск системы в целом.

#### /pkg/database/database.go

В этом файле инициализируется данная компонента, а также описаны все общие для этого уровня интерфейсы и структуры.

#### /pkg/database/postgres.go

Здесь реализовано подключение к СУБД и применение миграций (см. файлы в директории `/migration_files`).

#### /pkg/database/auth.go

Тут обрабатываются запросы, переданные из уровня выше и производятся соответствующие записи в базу данных.
